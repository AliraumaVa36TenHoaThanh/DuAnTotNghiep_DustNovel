<head>
    <meta charset="UTF-8">
    <title th:text="${title}">DustNovel</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- CSS theme s√°ng / t·ªëi -->
    <link rel="stylesheet" th:href="@{/DustNovel/css/theme.css}">
</head>


<div th:fragment="content">
    <div class="row">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <img th:src="${truyen.anhBia}" class="img-fluid rounded shadow-sm" alt="·∫¢nh b√¨a">
            </div>
            
            <div class="mt-3 d-grid gap-2">
                <a class="btn btn-success" th:href="@{/DustNovel/chuong/them/{id}(id=${truyen.id})}"
                   th:if="${@permissionService.canAddChuong(truyen.id)}">
                    <i class="bi bi-plus-circle"></i> ‚ûï Th√™m ch∆∞∆°ng
                </a>
                
                <a class="btn btn-warning" th:href="@{/DustNovel/truyen/{ten}/{id}/sua(ten=${truyen.tenTruyen}, id=${truyen.id})}"
                   th:if="${@permissionService.canEditTruyen(truyen.id)}">
                    <i class="bi bi-pencil-square"></i> ‚úèÔ∏è S·ª≠a truy·ªán
                </a>

                <form th:action="@{/DustNovel/truyen/{ten_truyen}/xoa/{id}(ten_truyen=${truyen.tenTruyen}, id=${truyen.id})}"
                      method="post"
                      th:if="${@permissionService.canDeleteTruyen(truyen.id)}"
                      onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° truy·ªán n√†y kh√¥ng?')">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-trash"></i> ‚ùå Xo√° truy·ªán
                    </button>
                </form>
            </div>
        </div>

        <div class="col-md-9">
            <h3 class="fw-bold" th:text="${truyen.tenTruyen}"></h3>
            <div class="mb-3">
                <p class="mb-1"><b>T√°c gi·∫£:</b> <span th:text="${truyen.tenTacGia}"></span></p>
                <p class="mb-1"><b>Ng∆∞·ªùi ƒëƒÉng:</b> <span class="text-primary" th:text="${truyen.nguoiDang.tenDangNhap}"></span></p>
                <p class="mb-1">
                    <b>N·ªôi dung:</b>
                    <span th:if="${truyen.tag18}" class="badge bg-danger">18+</span>
                    <span th:unless="${truyen.tag18}" class="badge bg-success">An to√†n</span>
                </p>
            </div>

            <div class="mb-3">
                <span class="badge bg-secondary me-1" th:each="tl : ${truyen.theLoais}" th:text="${tl.tenTheLoai}"></span>
            </div>

            <div class="card bg-light mb-4">
                <div class="card-body">
                    <h6 class="fw-bold">M√¥ t·∫£:</h6>
                    <p class="mb-0" th:text="${truyen.moTa}"></p>
                </div>
            </div>

            <hr>
            
            <h5 class="fw-bold mb-3"><i class="bi bi-list-ul"></i> Danh s√°ch ch∆∞∆°ng</h5>
            
            <ul class="list-group shadow-sm">
                <li class="list-group-item d-flex justify-content-between align-items-center" th:each="chap : ${dsChuong}">
                
                    <div th:if="${@permissionService.canReadChuong(chap, currentUser)}">
    <a th:href="@{/DustNovel/chuong/{id}(id=${chap.id})}"
       class="fw-bold text-dark text-decoration-none"
       th:text="${chap.tieuDe}">
    </a>
</div>

<div th:if="${!@permissionService.canReadChuong(chap, currentUser)}">
    <span class="text-muted" th:text="${chap.tieuDe}"></span>

    <a th:if="${#authorization.expression('isAuthenticated()')}"
       class="badge bg-danger ms-2"
       data-bs-toggle="modal"
       th:data-bs-target="'#muaChuongModal__' + ${chap.id}">
        üîí Mua (<span th:text="${chap.giaToken}"></span>)
    </a>

    <a th:if="${!#authorization.expression('isAuthenticated()')}"
       th:href="@{/DustNovel/login}"
       class="badge bg-dark ms-2">
        üîí ƒêƒÉng nh·∫≠p ƒë·ªÉ mua
    </a>
</div>


                    <div th:if="${@permissionService.canAddChuong(truyen.id)}">
                        <form th:action="@{/DustNovel/chuong/{id}/toggle-khoa(id=${chap.id})}" method="post" class="d-inline">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" 
                                    th:class="${chap.khoa ? 'btn btn-sm btn-outline-success' : 'btn btn-sm btn-outline-warning'}" 
                                    style="width: 100px;">
                                <span th:text="${chap.khoa ? 'üîì M·ªü kh√≥a' : 'üîí Kh√≥a'}"></span>
                            </button>
                        </form>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <div th:each="chap : ${dsChuong}" th:if="${chap.khoa}">
        <div class="modal fade" th:id="'muaChuongModal__' + ${chap.id}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">X√°c nh·∫≠n mua ch∆∞∆°ng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p class="mb-1">B·∫°n ƒëang mua: <b th:text="${chap.tieuDe}"></b></p>
                        <h4 class="text-danger fw-bold"><span th:text="${chap.giaToken}"></span> Token</h4>
                        <hr>
                        <div th:if="${currentUser != null}" class="bg-light p-2 rounded">
                            <span>S·ªë d∆∞ hi·ªán t·∫°i: </span>	
                            <b class="text-primary"><span th:text="${currentUser.token}"></span> Token</b>
                        </div>
                        <div th:unless="${currentUser != null}">
                            <div class="alert alert-warning py-2 mb-0">
                                ‚ö†Ô∏è B·∫°n ph·∫£i <a th:href="@{/DustNovel/login}" class="fw-bold">ƒëƒÉng nh·∫≠p</a> m·ªõi c√≥ th·ªÉ mua ch∆∞∆°ng n√†y.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        
                        <form th:if="${currentUser != null}" th:action="@{/DustNovel/chuong/{id}/mua(id=${chap.id})}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>	
                            <button type="submit" class="btn btn-danger px-4" 
                                    th:disabled="${currentUser.token < (chap.giaToken != null ? chap.giaToken : 0)}">
                                üí∞ X√°c nh·∫≠n mua
                            </button>
                        </form>
                        
                        <a th:if="${currentUser == null}" th:href="@{/DustNovel/login}" class="btn btn-primary">ƒêƒÉng nh·∫≠p</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>