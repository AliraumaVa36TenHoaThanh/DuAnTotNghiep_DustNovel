<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<link href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css"
	rel="stylesheet">
<script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>

<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">


<head>
<meta charset="UTF-8">
<title>H·ªì s∆° c√° nh√¢n</title>

<style>
*, *::before, *::after {
	box-sizing: border-box;
}

body {
	margin: 0;
	min-height: 100vh;
	font-family: "Segoe UI", Arial, sans-serif;
	background: url("/images/bglogin.jpg");
	background-size: cover;
}

.header {
	height: 315px;
	background: #cfcfcf;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 40px;
	letter-spacing: 6px;
	color: rgba(0, 0, 0, 0.15);
	font-weight: 700;
	background-size: cover;
	background-position: top;
	background-repeat: no-repeat;
}

.banner-tool {
	position: absolute;
	top: 0;
	left: 50%;
	transform: translateX(-50%);
	background: rgba(0, 0, 0, 0.15);
	border-radius: 0 0 40px 40px;
	padding: 14px 46px;
	display: flex;
	align-items: center;
	gap: 16px;
	opacity: 0;
	transition: 0.25s ease;
	z-index: 10;
}

.banner-icon {
	font-size: 26px;
	color: white;
	cursor: pointer;
	user-select: none;
}

.banner-icon.delete {
	background: none;
	border: none;
	padding: 0;
	transform: translateY(-7px);
	font-size: 20px;
}

.header:hover .banner-tool {
	opacity: 1;
}

.container {
	max-width: 1150px;
	margin: -60px auto 50px;
	display: flex;
	gap: 30px;
}

.profile-left {
	width: 320px;
	background: white;
	border-radius: 16px;
	padding: 25px;
	text-align: center;
	box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

.profile-right {
	flex: 1;
	background: white;
	border-radius: 16px;
	padding: 40px;
	box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

label {
	display: block;
	font-weight: 600;
	margin-top: 18px;
	color: black;
}

.avatar-box {
	position: relative;
	width: 120px;
	height: 120px;
	margin: -80px auto 10px;
	border-radius: 50%;
	overflow: hidden;
}

.avatar-box label {
	position: absolute;
	top: 0;
	left: -5px;
	margin: 0;
	display: flex;
	align-items: center;
	justify-content: center;
	width: 34px;
	height: 34px;
	background: transparent;
	border: none;
	box-shadow: none;
	font-size: 34px;
	cursor: pointer;
	color: white;
	z-index: 4;
}

.avatar-fallback {
	position: absolute;
	inset: 0;
	background: #d9d9d9;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 48px;
	font-weight: bold;
	color: #555;
	z-index: 1;
}

.avatar-img {
	position: absolute;
	inset: 0;
	width: 100%;
	height: 100%;
	object-fit: cover;
	z-index: 2;
}

.avatar-tool {
	position: absolute;
	bottom: 0;
	left: 50%;
	transform: translateX(-50%);
	background: rgba(0, 0, 0, 0.15);
	border-radius: 40px 40px 0 0;
	padding: 12px 18px;
	display: flex;
	align-items: center;
	gap: 14px;
	opacity: 0;
	transition: 0.25s ease;
	z-index: 3;
}

.avatar-icon {
	font-size: 20px;
	color: white;
	cursor: pointer;
	user-select: none;
	transition: transform 0.2s ease;
}

.avatar-icon.delete {
	background: none;
	border: none;
	padding: 0;
	font-size: 15px;
	color: white;
	transform: translateY(-3px);
}

.avatar-box:hover .avatar-tool {
	opacity: 1;
}

.status {
	color: #28a745;
	font-weight: bold;
	margin: 10px 0 20px;
}

.stats {
	display: grid;
	grid-template-columns: repeat(3, 1fr);
	gap: 10px;
	margin-bottom: 20px;
}

.stats div {
	background: #f1f3f5;
	border-radius: 10px;
	padding: 10px 0;
	font-size: 14px;
}

.stats strong {
	display: block;
	font-size: 18px;
}

.profile-left button {
	width: 100%;
	padding: 11px;
	border-radius: 10px;
	border: none;
	font-weight: 600;
	cursor: pointer;
	margin-top: 10px;
}

.btn-danger {
	background: #e9ecef;
	color: black;
}

.btn-danger:hover {
	background: black;
	color: white;
}

.btn-logout {
	background: #e9ecef;
	color: black;
	border: 1px solid white;
}

.btn-logout:hover {
	background: black;
	color: white;
}

input {
	width: 100%;
	padding: 13px;
	margin-top: 6px;
	border-radius: 10px;
	border: 1px solid #ccc;
	font-size: 15px;
	background: #f2f2f2;
	margin-bottom: 10px;
}

input:disabled {
	cursor: not-allowed;
}

input.editable {
	background: white;
}

.error {
	color: #dc3545;
	font-size: 14px;
	margin-top: 4px;
}

.success {
	background: #e6fffa;
	color: #0f5132;
	padding: 14px;
	border-radius: 10px;
	margin-bottom: 20px;
}

.btn-edit {
	background: #198754;
	color: white;
	padding: 12px 26px;
	border-radius: 10px;
	border: none;
	cursor: pointer;
	font-weight: 600;
	margin: 15px 0 25px;
}

.btn-edit:hover {
	background: black;
	color: white;
}

#btnUpdate {
	background: #198754;
	color: white;
	padding: 12px 26px;
	border-radius: 10px;
	border: none;
	font-weight: 600;
	cursor: pointer;
	display: none;
}

#btnUpdate:hover {
	background: black;
	color: white;
}

.form-actions {
	margin-top: 30px;
	display: flex;
	align-items: center;
	gap: 25px;
}

a {
	text-decoration: none;
	font-weight: 600;
	color: #198754;
}

a:hover {
	color: red;
}

.password-wrapper {
	position: relative;
	width: 100%;
}

.password-wrapper input {
	width: 100%;
	padding: 13px 44px 13px 13px;
	box-sizing: border-box;
}

.toggle-password {
	position: absolute;
	right: 14px;
	top: 50%;
	transform: translateY(-50%);
	cursor: pointer;
	font-size: 18px;
	color: #666;
	user-select: none;
}

.toggle-password:hover {
	color: #000;
}

.avatar-modal {
	position: fixed;
	inset: 0;
	background: rgba(0, 0, 0, 0.65);
	display: none;
	align-items: center;
	justify-content: center;
	z-index: 9999;
}

.avatar-modal-box {
	background: #fff;
	padding: 16px;
	border-radius: 14px;
	width: 420px;
}

#previewAvatar {
	width: 100%;
	height: 300px;
	object-fit: cover;
	display: block;
	border-radius: 8px;
}

#previewBanner {
	width: 100%;
	height: 300px;
	object-fit: cover;
	display: block;
	border-radius: 8px;
}

.cropper-container {
	max-width: 100% !important;
}

.avatar-modal-actions {
	margin-top: 14px;
	display: flex;
	gap: 12px;
}

.avatar-modal-actions button {
	flex: 1;
	padding: 12px;
	border-radius: 10px;
	font-weight: 600;
	border: none;
	cursor: pointer;
}

.avatar-modal-actions button:first-child {
	background: #dc3545;
	color: white;
}

.avatar-modal-actions button:first-child:hover {
	background: black;
}

.avatar-modal-actions button:last-child {
	background: #198754;
	color: white;
}
</style>


<script>

function enableEdit() {
	document.querySelectorAll(".editable").forEach(i => i.disabled = false);
	document.getElementById("btnUpdate").style.display = "inline-block";
}

window.onload = function () {
	if (document.querySelector(".error")) {
		enableEdit();
	}
}

function confirmLogout() {
	return confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?");
}



function confirmDeleteAvatar() {
	return confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh ƒë·∫°i di·ªán kh√¥ng?");
}



let cropper = null;
let selectedFile = null;

function openAvatarEditor(input) {
    if (!input.files || !input.files[0]) return;

    selectedFile = input.files[0];

    const modal = document.getElementById("avatarModal");
    const img = document.getElementById("previewAvatar");

    img.src = URL.createObjectURL(selectedFile);
    modal.style.display = "flex";

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    img.onload = () => {
        cropper = new Cropper(img, {
            aspectRatio: 1,        
            viewMode: 1,
            dragMode: "none",     
            cropBoxMovable: true,   
            cropBoxResizable: true, 
            autoCropArea: 0.6,
            background: false,
            guides: true,
            center: true,
            responsive: true
        });
    };
}

function closeAvatarModal() {
    const modal = document.getElementById("avatarModal");
    modal.style.display = "none";

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    selectedFile = null;
}

function submitAvatar() {
    if (!cropper) return;

    cropper.getCroppedCanvas({
        width: 400,
        height: 400,
        imageSmoothingQuality: "high"
    }).toBlob(blob => {
        const formData = new FormData();
        formData.append("file", blob, "avatar.png");

        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        const headers = {};
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        fetch("/DustNovel/user/avatar", {
            method: "POST",
            body: formData,
            headers: headers,
            credentials: "same-origin"  
        })
        .then(res => {
            if (!res.ok) throw new Error("Upload failed");
            location.reload();
        })
        .catch(err => {
            console.error(err);
            alert("L·ªói khi c·∫≠p nh·∫≠t avatar");
        });
    });
}

let bannerCropper = null;
let bannerFile = null;

function openBannerEditor(input) {
    if (!input.files || !input.files[0]) return;

    bannerFile = input.files[0];

    const modal = document.getElementById("bannerModal");
    const img = document.getElementById("previewBanner");

    img.src = URL.createObjectURL(bannerFile);
    modal.style.display = "flex";

    if (bannerCropper) {
        bannerCropper.destroy();
        bannerCropper = null;
    }

    img.onload = () => {
        bannerCropper = new Cropper(img, {
            aspectRatio: 16 / 5,   
            viewMode: 1,
            autoCropArea: 1,
            background: false,
            responsive: true
        });
    };
}

function closeBannerModal() {
    document.getElementById("bannerModal").style.display = "none";
    if (bannerCropper) {
        bannerCropper.destroy();
        bannerCropper = null;
    }
}

function submitBanner() {
    if (!bannerCropper) return;

    bannerCropper.getCroppedCanvas({
        width: 1600,
        height: 500,
        imageSmoothingQuality: "high"
    }).toBlob(blob => {
        const formData = new FormData();
        formData.append("file", blob, "banner.jpg");

        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        const headers = {};
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        fetch("/DustNovel/user/banner", {
            method: "POST",
            body: formData,
            headers: headers,
            credentials: "same-origin"
        })
        .then(res => {
            if (!res.ok) throw new Error();
            location.reload();
        })
        .catch(() => alert("L·ªói upload banner"));
    });
}

</script>
</head>
<body >

	<div class="header"
		th:style="${user.banner != null} ? 'background-image:url(' + @{${user.banner}} + ')' : ''">
		<div class="banner-tool" onclick="event.stopPropagation()">
			<span class="banner-icon"
				onclick="document.getElementById('bannerInput').click()">üì∑</span>
			<form th:if="${user.banner != null}"
				th:action="@{/DustNovel/user/banner/delete}" method="post"
				onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a banner kh√¥ng?')">
				<button type="submit" class="banner-icon delete">üóëÔ∏è</button>
			</form>
		</div>
		<form th:action="@{/DustNovel/user/banner}" method="post"
			enctype="multipart/form-data">
			<input id="bannerInput" type="file" name="file" accept="image/*"
				hidden onchange="openBannerEditor(this)">
		</form>
	</div>
	<div id="bannerModal" class="avatar-modal">
		<div class="avatar-modal-box" style="width: 900px;">
			<img id="previewBanner">
			<div class="avatar-modal-actions">
				<button type="button" onclick="closeBannerModal()">ƒê√≥ng</button>
				<button type="button" onclick="submitBanner()">ƒê·ªïi banner</button>
			</div>
		</div>
	</div>



	<div class="container">
		<div class="profile-left">
			<div class="avatar-box">
				<div class="avatar-fallback"
					th:text="${#strings.toUpperCase(#strings.substring(user.tenDangNhap,0,1))}">
				</div>
				<img th:if="${user.avatar != null}" th:src="@{${user.avatar}}"
					class="avatar-img" />
				<div class="avatar-tool" onclick="event.stopPropagation()">
					<span class="avatar-icon"
						onclick="document.getElementById('avatarInput').click()">üì∑</span>
					<form th:if="${user.avatar != null}"
						th:action="@{/DustNovel/user/avatar/delete}" method="post"
						onsubmit="return confirmDeleteAvatar()">
						<button type="submit" class="avatar-icon delete">üóëÔ∏è</button>
					</form>
				</div>
				<input id="avatarInput" type="file" name="file" accept="image/*"
					hidden onchange="openAvatarEditor(this)">
				<div id="avatarModal" class="avatar-modal">
					<div class="avatar-modal-box">
						<img id="previewAvatar">
						<div class="avatar-modal-actions">
							<button type="button" onclick="closeAvatarModal()">ƒê√≥ng</button>
							<button type="button" onclick="submitAvatar()">ƒê·ªïi ·∫£nh</button>
						</div>
					</div>
				</div>
			</div>
			<h3 th:text="${user.tenDangNhap}"></h3>
			<p th:text="${user.email}"></p>
			<div class="status">ƒêang ho·∫°t ƒë·ªông</div>
			<div class="stats">
				<div>
					<strong>0</strong>Truy·ªán
				</div>
				<div>
					<strong>0</strong>Theo d√µi
				</div>
				<div>
					<strong>0</strong>B√¨nh lu·∫≠n
				</div>
			</div>
			<form th:action="@{/DustNovel/user/delete}" method="post"
				onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n?')">
				<button class="btn-danger">X√≥a t√†i kho·∫£n</button>
			</form>
			<form th:action="@{/DustNovel/logout}" method="post"
				onsubmit="return confirmLogout()">
				<button class="btn-logout">ƒêƒÉng xu·∫•t</button>
			</form>
		</div>


		<div class="profile-right">
			<h2>TH√îNG TIN T√ÄI KHO·∫¢N</h2>
			<button type="button" class="btn-edit" onclick="enableEdit()">Thay
				ƒë·ªïi m·∫≠t kh·∫©u</button>
				
			<div th:if="${success != null and success == true}" class="success">C·∫≠p
				nh·∫≠t m·∫≠t kh·∫©u th√†nh c√¥ng</div>
				
			<form th:action="@{/DustNovel/user/profile/update}" method="post">
				<label>T√™n ƒëƒÉng nh·∫≠p</label> <input disabled
					th:value="${tenDangNhapValue != null ? tenDangNhapValue : user.tenDangNhap}">
				<input type="hidden" name="tenDangNhap"
					th:value="${tenDangNhapValue != null ? tenDangNhapValue : user.tenDangNhap}">
				<div class="error" th:if="${tenDangNhapError}"
					th:text="${tenDangNhapError}"></div>
					
				<label>Email</label> <input name="email" placeholder="V√≠ d·ª•: example@gmail.com" class="editable" disabled
					th:value="${emailValue != null ? emailValue : user.email}">
				<div class="error" th:if="${emailError}" th:text="${emailError}"></div>
				
				<label>ƒê·ªïi m·∫≠t kh·∫©u (kh√¥ng b·∫Øt bu·ªôc)</label>
				<div class="password-wrapper">
					<input id="matKhauMoi" class="editable" disabled type="password"
						name="matKhauMoi" placeholder="V√≠ d·ª•: Abc@1234"
						th:value="${matKhauMoi}">
				  </div>
				<div class="error" th:if="${matKhauMoiError}"
					th:text="${matKhauMoiError}"></div>

				<div class="password-wrapper">
					<input id="xacNhanMatKhau" class="editable" disabled
						type="password" name="xacNhanMatKhau"
						placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" th:value="${xacNhanMatKhau}">
				</div>
				<div class="error" th:if="${xacNhanMatKhauError}"
					th:text="${xacNhanMatKhauError}"></div>
				<div class="form-actions">
					<button id="btnUpdate" type="submit">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u</button>
					<a href="/DustNovel/home">‚Üê Quay v·ªÅ trang ch·ªß</a>
				</div>
			</form>
		</div>
	</div>
</body>
</html>
